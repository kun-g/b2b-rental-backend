# CMS 开发 TODO

## 已完成 ✅

- [x] 创建 14 个核心 Collections（基于 PRD v0.2）
- [x] 配置权限控制（基于角色的访问控制 RBAC）
- [x] 实现基础 Hooks（订单号生成、状态流转、授信历史记录等）
- [x] 生成 TypeScript 类型定义
- [x] 编写 Collections 设计文档

## 待完成 🚧

### 优先级 P0（必须完成）

#### 1. 数据库配置
- [ ] 配置 PostgreSQL 数据库连接
- [ ] 本地开发环境可选SQLite3
- [ ] 运行数据库迁移
- [ ] 创建初始 Seed 数据
  - 平台管理员账号
  - 默认类目（电子设备、无人机等）
  - 测试商户和用户

#### 2. 业务逻辑补充
- [ ] **授信管理**
  - [ ] 订单创建时冻结授信额度
  - [ ] 订单完成/取消时释放授信额度
  - [ ] 授信额度不足时阻止下单
- [ ] **订单状态机**
  - [ ] 完善状态流转验证（如 SHIPPED 不能回退到 TO_SHIP）
  - [ ] 实现 PAID → TO_SHIP 自动流转
  - [ ] 实现逾期计算和逾期支付单生成
- [ ] **运费计算**
  - [ ] 下单时根据地址和模板计算运费
  - [ ] 改址时计算运费差额
  - [ ] 不发地区拦截逻辑
- [ ] **对账单生成**
  - [ ] 订单完成时自动生成对账单
  - [ ] 对账单包含所有费用明细

#### 3. 权限细化
- [ ] 实现商户成员细粒度权限（仓配、运营、财务等角色）
- [ ] 实现平台客服只读权限
- [ ] 实现敏感操作二次确认（授信调整、强制流转等）

### 优先级 P1（重要）

#### 4. 数据验证
- [ ] 订单金额计算验证（租金+运费+逾期+改址）
- [ ] 租期日期验证（结束日期 > 开始日期）
- [ ] 库存数量验证（下单时检查库存）
- [ ] 改址次数限制验证（≤2次）
- [ ] 手机号格式验证

#### 5. 审计日志
- [ ] 实现自动记录敏感操作
  - 授信调整
  - 强制流转
  - 不发地区豁免
  - 商户审核
  - SKU审核
- [ ] 记录操作人IP和User Agent

#### 6. UI优化
- [ ] 自定义订单详情页面（显示状态流转时间线）
- [ ] 自定义授信管理页面（显示额度使用情况）
- [ ] 自定义对账单页面（支持导出PDF/Excel）

### 优先级 P2（可选）

#### 7. 支付集成
- [ ] 集成微信支付
- [ ] 集成支付宝
- [ ] 实现支付回调处理
- [ ] 实现退款逻辑

#### 8. 物流集成
- [ ] 对接物流API（顺丰、德邦等）
- [ ] 实现物流轨迹自动回传
- [ ] 实现签收自动确认
- [ ] 物流异常提醒

#### 9. 通知系统
- [ ] 邮件通知（订单状态变更、审核结果等）
- [ ] 短信通知（订单确认、发货提醒等）
- [ ] 站内消息

#### 10. 报表统计
- [ ] 商户订单统计（成交笔数、金额、租赁率）
- [ ] 用户消费统计
- [ ] 设备利用率统计
- [ ] 逾期分析

#### 11. 批量操作
- [ ] 批量导入SKU
- [ ] 批量导入设备
- [ ] 批量导出订单
- [ ] 批量导出对账单

#### 12. 高级功能
- [ ] SKU 租期日历（显示可租时段）
- [ ] 设备二维码生成与扫码管理
- [ ] 发票管理
- [ ] 商户结算自动化

---

## 技术债务 🔧

### 代码优化
- [ ] 抽取公共字段到 Mixin（如 timestamps、operator 等）
- [ ] 抽取公共权限逻辑到 Helper 函数
- [ ] 优化 Hooks 性能（避免重复查询）

### 测试
- [ ] 单元测试（Collection Hooks）
- [ ] 集成测试（权限控制）
- [ ] E2E 测试（关键业务流程）

### 文档
- [ ] API 文档（GraphQL Schema）
- [ ] 部署文档
- [ ] 运维手册

---

## 开发规范

### Git Commit 规范
```
feat: 新功能
fix: 修复bug
docs: 文档更新
refactor: 重构
test: 测试
chore: 构建/工具链
```

### 分支策略
- `main` - 生产环境
- `develop` - 开发环境
- `feature/*` - 功能分支
- `hotfix/*` - 紧急修复

### Code Review
- 所有 PR 需要至少 1 人 Review
- 关键功能需要 2 人 Review

---

## 部署清单

### 环境变量
```env
# 数据库
DATABASE_URI=postgresql://...

# Payload
PAYLOAD_SECRET=your-secret-key
PAYLOAD_PUBLIC_SERVER_URL=https://your-domain.com

# 支付（可选）
WECHAT_PAY_APP_ID=
WECHAT_PAY_MERCHANT_ID=
ALIPAY_APP_ID=

# 物流（可选）
SF_EXPRESS_APP_ID=
SF_EXPRESS_APP_SECRET=

# 通知（可选）
SMTP_HOST=
SMTP_PORT=
SMTP_USER=
SMTP_PASS=

SMS_ACCESS_KEY_ID=
SMS_ACCESS_KEY_SECRET=
```

### 数据库迁移
```bash
# 运行迁移
pnpm run db:migrate

# Seed 初始数据
pnpm run db:seed
```

### 构建部署
```bash
# 构建
pnpm build

# 启动
pnpm start
```

---

## 联系方式

如有问题，请联系：
- 技术负责人：[TODO]
- 产品负责人：[TODO]
